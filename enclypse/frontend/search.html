<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Enclypse â€“ Search</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main>
      <nav>
        <a href="sphere.html">Sphere</a>
        <a href="contacts.html">Contacts</a>
        <a href="search.html" class="active">Search</a>
        <a href="chat.html">Chat</a>
        <a href="profile.html">Profile</a>
        <a href="#" id="logout-link">Logout</a>
      </nav>
      <section class="card">
        <h1>Discover people</h1>
        <input type="search" id="search" placeholder="Search by username or display name" />
        <div class="list" id="results"></div>
      </section>
    </main>
    <script type="module">
      import { searchUsers, connectPresenceSocket, logout } from './common.js';

      const input = document.getElementById('search');
      const results = document.getElementById('results');

      async function runSearch() {
        const query = input.value.trim();
        if (!query) {
          results.innerHTML = '<p class="badge">Type to search Enclypse.</p>';
          return;
        }
        const data = await searchUsers(query);
        if (!data.results.length) {
          results.innerHTML = '<p class="badge">No results.</p>';
          return;
        }
        results.innerHTML = '';
        data.results.forEach((user) => {
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `
            <div>
              <strong>${user.displayName || user.username}</strong>
              <p class="badge">
                <span class="status-dot ${user.online ? 'online' : 'offline'}"></span>
                ${user.online ? 'Online' : 'Offline'}
              </p>
            </div>
            <button class="secondary" data-username="${user.username}">View</button>
          `;
          item.querySelector('button').addEventListener('click', () => {
            window.location.href = `profile.html?user=${encodeURIComponent(user.username)}`;
          });
          results.appendChild(item);
        });
      }

      let debounce;
      input.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(runSearch, 250);
      });

      connectPresenceSocket((payload) => {
        [...results.children].forEach((child) => {
          const username = child.querySelector('button').dataset.username;
          const user = payload.users.find((u) => u.username === username);
          if (user) {
            child.querySelector('.badge').innerHTML = `<span class="status-dot ${user.online ? 'online' : 'offline'}"></span> ${user.online ? 'Online' : 'Offline'}`;
          }
        });
      });

      document.getElementById('logout-link').addEventListener('click', (event) => {
        event.preventDefault();
        logout();
      });
    </script>
  </body>
</html>
